<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistente Futurista</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(to right, #141e30, #243b55);
      color: #fff;
    }

    #chat-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #00d4ff;
      color: white;
      padding: 15px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 26px;
      z-index: 9999;
      box-shadow: 0 0 20px #00d4ff;
      transition: transform 0.2s;
    }

    #chat-button:hover {
      transform: scale(1.1);
    }

    #chat-box {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 340px;
      height: 520px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid #00d4ff;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      z-index: 9999;
      backdrop-filter: blur(10px);
      display: none;
    }

    #chat-header {
      background: #00d4ff;
      color: white;
      padding: 10px;
      font-weight: bold;
      text-align: center;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #chat-header label {
      font-size: 12px;
      margin-right: 10px;
      display: flex;
      align-items: center;
    }

    #voice-controls {
      display: none;
    }

    #voice-controls button {
      font-size: 14px;
      margin-left: 5px;
      padding: 6px 10px;
      border-radius: 5px;
      border: none;
      background: white;
      color: #00d4ff;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease;
    }

    #voice-controls button:hover {
      background-color: #e0f7ff;
    }

    #chat-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      font-size: 14px;
      color: rgb(0, 0, 0);
    }

    .msg {
      margin: 8px 0;
      padding: 8px 12px;
      border-radius: 10px;
      max-width: 80%;
      clear: both;
    }

    .user {
      background: #00d4ff;
      color: white;
      float: right;
      text-align: right;
    }

    .bot {
      background: rgba(255, 255, 255, 0.2);
      float: left;
    }

    #chat-form {
      display: flex;
      border-top: 1px solid #00d4ff;
    }

    #chat-input {
      flex: 1;
      border: none;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      color: rgb(0, 0, 0);
      outline: none;
    }

    #chat-form button {
      background: #00d4ff;
      color: white;
      border: none;
      padding: 10px;
      cursor: pointer;
    }

    #tsparticles {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
}

  </style>
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@3/tsparticles.bundle.min.js"></script>
</head>
<body>

<div id="chat-button" title="Abrir chat">ü§ñ</div>

<div id="chat-box">
  <div id="chat-header">
    <span>Assistente Futurista</span>
    <div style="display: flex; align-items: center;">
      <label>
        <input type="checkbox" id="voice-toggle" style="margin-right: 5px;" />
        IA com voz
      </label>
      <div id="voice-controls">
        <button id="play-voice" type="button" title="Tocar resposta">üîä</button>
        <!-- <button id="stop-voice" type="button" title="Parar resposta">‚èπ Stop</button> -->
      </div>
    </div>
  </div>
  <div id="chat-messages"></div>
  <form id="chat-form">
    <input type="text" id="chat-input" placeholder="Digite aqui..." autocomplete="off" />
    <button type="submit">‚Æû</button>
  </form>
</div>

<script>
  const chatButton = document.getElementById("chat-button");
  const chatBox = document.getElementById("chat-box");
  const chatForm = document.getElementById("chat-form");
  const chatInput = document.getElementById("chat-input");
  const chatMessages = document.getElementById("chat-messages");
  const voiceToggle = document.getElementById("voice-toggle");
  const voiceControls = document.getElementById("voice-controls");
  const playVoice = document.getElementById("play-voice");
  const stopVoice = document.getElementById("stop-voice");

  let userName = localStorage.getItem("userName");
  let voiceEnabled = localStorage.getItem("voiceEnabled") === "true";

  voiceToggle.checked = voiceEnabled;
  voiceControls.style.display = voiceEnabled ? "block" : "none";

  let isSpeaking = false;
  let utterance = null;

  voiceToggle.addEventListener("change", () => {
    voiceEnabled = voiceToggle.checked;
    localStorage.setItem("voiceEnabled", voiceEnabled);
    voiceControls.style.display = voiceEnabled ? "block" : "none";

    if (!voiceEnabled) {
      stopSpeech();
    }
  });

  chatButton.addEventListener("click", () => {
    const wasHidden = chatBox.style.display === "none" || chatBox.style.display === "";
    chatBox.style.display = wasHidden ? "flex" : "none";
    if (wasHidden) {
      setTimeout(() => {
        chatInput.focus();
        if (!userName) {
          const pergunta = "Ol√°! Qual √© o seu nome?";
          appendMessage("Assistente", pergunta, "bot");
          botSpeak(pergunta);
        } else {
          greetUser(userName);
        }
      }, 300);
    }
  });

  chatForm.addEventListener("submit", function (e) {
    e.preventDefault();
    const message = chatInput.value.trim();
    if (message === "") return;

    appendMessage("Voc√™", message, "user");
    chatInput.value = "";

    if (!userName) {
      userName = message;
      localStorage.setItem("userName", userName);
      const greeting = `Prazer em conhecer voc√™, ${userName}. Como posso te ajudar hoje?`;
      appendMessage("Assistente", greeting, "bot");
      botSpeak(greeting);
      return;
    }

    fetch("responder.php", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: "pergunta=" + encodeURIComponent(message) + "&nome=" + encodeURIComponent(userName)
    })
    .then(res => res.text())
    .then(resposta => {
      appendMessage("Assistente", resposta, "bot");
      botSpeak(resposta);
    })
    .catch(err => {
      appendMessage("Assistente", "Falha ao conectar com o servidor.", "bot");
      botSpeak("Desculpe, houve um erro na conex√£o.");
      console.error(err);
    });
  });

  function appendMessage(sender, text, type) {
    const msg = document.createElement("div");
    msg.classList.add("msg", type);
    msg.innerHTML = `<strong>${sender}:</strong> ${text}`;
    chatMessages.appendChild(msg);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function botSpeak(text) {
    if (!voiceEnabled || !window.speechSynthesis) return;

    stopSpeech();

    utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "pt-BR";
    utterance.rate = 1;
    utterance.pitch = 1.1;

    utterance.onstart = () => {
      isSpeaking = true;
      updatePlayButton(true);
    };

    utterance.onend = () => {
      isSpeaking = false;
      updatePlayButton(false);
    };

    utterance.onerror = () => {
      isSpeaking = false;
      updatePlayButton(false);
    };

    window.speechSynthesis.speak(utterance);
  }

  function stopSpeech() {
    if (window.speechSynthesis && isSpeaking) {
      window.speechSynthesis.cancel();
      isSpeaking = false;
      updatePlayButton(false);
    }
  }

  function updatePlayButton(speaking) {
    if (speaking) {
      playVoice.textContent = "‚è∏";
      playVoice.title = "Pausar fala";
      stopVoice.disabled = false;
    } else {
      playVoice.textContent = "üîä";
      playVoice.title = "Tocar resposta";
      stopVoice.disabled = true;
    }
  }

  function greetUser(name) {
    const welcome = `Ol√° novamente, ${name}. Em que posso ajudar?`;
    appendMessage("Assistente", welcome, "bot");
    botSpeak(welcome);
  }

  playVoice.addEventListener("click", () => {
    if (!voiceEnabled) return;
    if (isSpeaking) {
      // Pausar (cancelar)
      stopSpeech();
    } else {
      // Reproduzir a √∫ltima fala
      const lastBotMessage = [...chatMessages.querySelectorAll(".msg.bot")].pop();
      if (lastBotMessage) {
        const text = lastBotMessage.textContent.replace("Assistente:", "").trim();
        botSpeak(text);
      }
    }
  });

  stopVoice.addEventListener("click", () => {
    if (!voiceEnabled) return;
    stopSpeech();
  });

  // Inicializa estado do bot√£o Stop desabilitado
  stopVoice.disabled = true;

</script>

</body>


</html>
